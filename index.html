<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chat to Markdown Converter</title>
    <script src="turndown.js"></script>
    <style>
        :root { --primary: #2563eb; --bg: #f8fafc; }
        body { font-family: system-ui, sans-serif; background: var(--bg); display: flex; flex-direction: column; align-items: center; padding: 40px 20px; }
        .container { max-width: 600px; width: 100%; background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        h1 { font-size: 1.5rem; color: #1e293b; margin-bottom: 1rem; }
        .drop-zone { border: 2px dashed #cbd5e1; border-radius: 8px; padding: 40px; text-align: center; cursor: pointer; transition: 0.2s; }
        .drop-zone:hover { border-color: var(--primary); background: #f0f9ff; }
        #fileInput { display: none; }
        .btn { display: inline-block; margin-top: 20px; background: var(--primary); color: white; padding: 12px 24px; border-radius: 6px; text-decoration: none; font-weight: 600; cursor: pointer; border: none; }
        #status { margin-top: 15px; font-size: 0.9rem; color: #64748b; }
    </style>
</head>
<body>

    <div class="container">
        <h1>AI Chat â†’ Markdown</h1>
        <p>Upload the <b>.html</b> file you saved from your chat.</p>
        
        <label for="fileInput" class="drop-zone" id="dropZone">
            <span>Click to upload or drag & drop HTML file</span>
            <input type="file" id="fileInput" accept=".html">
        </label>

        <div id="status"></div>
        <button id="downloadBtn" class="btn" style="display: none;">Download Markdown (.md)</button>
    </div>

    <script>
        const fileInput = document.getElementById('fileInput');
const status = document.getElementById('status');
const downloadBtn = document.getElementById('downloadBtn');
let convertedMarkdown = "";

const turndownService = new TurndownService({
    headingStyle: 'atx',
    codeBlockStyle: 'fenced',
    hr: '---'
});

// --- NEW: LLM API Helper ---
async function ideaBoundary(currentMessage, previousSection, intentPoints) {
    const jokeing = "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"; // Keep this safe!
    const url = "https://api.groq.com/openai/v1/chat/completions";

    const prompt = `
Current section title: ${previousSection}
New user message: ${currentMessage}
Intent_points: ${JSON.stringify(intentPoints)}

Respond using exactly this JSON schema:
{
  "decision": "NEW_TOPIC | CONTINUE_TOPIC",
  "section_title": "string",
  "subsection_title": "string",
  "intent_points": ["string"]
}
    `;

    try {
        const response = await fetch(url, {
            method: "POST",
            headers: {
                "Authorization": `Bearer ${jokeing}`,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                model: "llama-3.3-70b-versatile",
                messages: [
                    { role: "system", content: "You are an indexing engine. Return ONLY valid JSON." },
                    { role: "user", content: prompt }
                ],
                response_format: { type: "json_object" }
            })
        });

        const data = await response.json();
        return JSON.parse(data.choices[0].message.content);
    } catch (e) {
        console.error("LLM Error:", e);
        return { decision: "NEW_TOPIC", section_title: "General Chat", subsection_title: null, intent_points: [] };
    }
}

fileInput.addEventListener('change', handleFile);

// --- UPDATED: Async File Handler ---
async function handleFile(e) {
    const file = e.target.files[0];
    if (!file) return;

    status.innerText = "Processing file and analyzing sections...";
    const reader = new FileReader();

    reader.onload = async function(event) {
        try {
            const htmlContent = event.target.result;
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlContent, 'text/html');
            
            const messages = doc.querySelectorAll('div[data-message-author-role]');
            let mdOutput = "";

            if (messages.length === 0) {
                status.innerText = "Error: No messages found.";
                return;
            }

            // --- NEW: State Management ---
            let lastSection = "Introduction";
            let currentIntents = [];

            // IMPORTANT: Use for...of for async support
            for (const [index, msg] of messages.entries()) {
                const role = msg.getAttribute('data-message-author-role').toUpperCase();
                const content = msg.querySelector('.markdown, .prose, .whitespace-pre-wrap');
                
                if (content) {
                    const md = turndownService.turndown(content.innerHTML);
                    
                    if (role === 'USER') {
                        status.innerText = `Analyzing message ${index + 1} of ${messages.length}...`;
                        
                        const result = await ideaBoundary(md, lastSection, currentIntents);
                        
                        // Update our state
                        lastSection = result.section_title || lastSection;
                        currentIntents = result.intent_points;

                        // Insert headers based on LLM decision
                        if (result.decision === "NEW_TOPIC") {
                            mdOutput += `\n# ${result.section_title}\n\n`;
                        } else if (result.subsection_title) {
                            mdOutput += `\n## ${result.subsection_title}\n\n`;
                        }
                    }

                    mdOutput += `### ${role}\n\n${md}\n\n---\n\n`;
                }
            }

            convertedMarkdown = mdOutput;
            status.innerText = `Successfully converted ${messages.length} messages with LLM indexing!`;
            downloadBtn.style.display = "inline-block";
        } catch (err) {
            status.innerText = "Error parsing file.";
            console.error(err);
        }
    };

    reader.readAsText(file);
}

        // 3. Download Logic
        downloadBtn.addEventListener('click', () => {
            const blob = new Blob([convertedMarkdown], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `chat-export-${Date.now()}.md`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        });
    </script>
</body>
</html>
